<!DOCTYPE html>
  <html lang="zh">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ç”Ÿæ´»é—®é¢˜è§£å†³åŠ©æ‰‹</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }

          body {
              font-family: 'Arial', sans-serif;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              display: flex;
              justify-content: center;
              align-items: center;
          }

          .chat-container {
              width: 800px;
              max-width: 90vw;
              height: 600px;
              background: white;
              border-radius: 20px;
              box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
              display: flex;
              flex-direction: column;
              overflow: hidden;
          }

          .chat-header {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
          }

          .header-left {
              display: flex;
              flex-direction: column;
          }

          .header-title {
              font-size: 24px;
              font-weight: bold;
              margin-bottom: 5px;
          }

          .header-user {
              font-size: 14px;
              opacity: 0.9;
          }

          .header-right {
              display: flex;
              gap: 10px;
          }

          .header-btn {
              padding: 8px 16px;
              background: rgba(255, 255, 255, 0.2);
              border: none;
              border-radius: 15px;
              color: white;
              cursor: pointer;
              font-size: 14px;
              transition: background 0.3s;
          }

          .header-btn:hover {
              background: rgba(255, 255, 255, 0.3);
          }

          .upgrade-btn {
              padding: 8px 16px;
              background: linear-gradient(45deg, #ffd700, #ffed4e);
              border: none;
              border-radius: 15px;
              color: #333;
              cursor: pointer;
              font-size: 14px;
              font-weight: bold;
              transition: all 0.3s;
              margin-right: 10px;
          }

          .upgrade-btn:hover {
              background: linear-gradient(45deg, #ffed4e, #ffd700);
              transform: translateY(-2px);
              box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
          }

          .chat-messages {
              flex: 1;
              padding: 20px;
              overflow-y: auto;
              background: #f8f9fa;
          }

          .message {
              margin-bottom: 15px;
              display: flex;
              align-items: flex-start;
          }

          .message.user {
              justify-content: flex-end;
          }

          .message.assistant {
              justify-content: flex-start;
          }

          .message-content {
              max-width: 70%;
              padding: 12px 16px;
              border-radius: 18px;
              word-wrap: break-word;
              line-height: 1.4;
              white-space: pre-wrap;
          }

          .message.user .message-content {
              background: #667eea;
              color: white;
          }

          .message.assistant .message-content {
              background: white;
              color: #333;
              border: 1px solid #e0e0e0;
          }

          .chat-input {
              display: flex;
              padding: 20px;
              background: white;
              border-top: 1px solid #e0e0e0;
          }

          .input-field {
              flex: 1;
              padding: 15px 20px;
              border: 1px solid #e0e0e0;
              border-radius: 25px;
              outline: none;
              font-size: 16px;
              resize: none;
              min-height: 50px;
              max-height: 150px;
          }

          .input-field:focus {
              border-color: #667eea;
          }

          .input-field:disabled {
              background-color: #f8f9fa;
              color: #6c757d;
              cursor: not-allowed;
          }

          .send-button {
              margin-left: 10px;
              padding: 15px 25px;
              background: #667eea;
              color: white;
              border: none;
              border-radius: 25px;
              cursor: pointer;
              font-size: 16px;
              font-weight: bold;
              transition: background 0.3s;
          }

          .send-button:hover {
              background: #5a6fd8;
          }

          .send-button:disabled {
              background: #ccc;
              cursor: not-allowed;
          }

          .loading {
              display: none;
              padding: 12px 16px;
              background: #f0f0f0;
              border-radius: 18px;
              max-width: 70%;
          }

          .loading.show {
              display: block;
          }

          .typing-indicator {
              display: flex;
              align-items: center;
              gap: 4px;
          }

          .typing-indicator span {
              width: 8px;
              height: 8px;
              background: #667eea;
              border-radius: 50%;
              animation: typing 1.4s infinite;
          }

          .typing-indicator span:nth-child(2) {
              animation-delay: 0.2s;
          }

          .typing-indicator span:nth-child(3) {
              animation-delay: 0.4s;
          }

          @keyframes typing {
              0%, 60%, 100% {
                  transform: translateY(0);
              }
              30% {
                  transform: translateY(-10px);
              }
          }

          .chat-history {
              max-height: 400px;
              overflow-y: auto;
          }

          .clear-btn {
              background: rgba(255, 255, 255, 0.2);
              border: none;
              border-radius: 15px;
              color: white;
              cursor: pointer;
              font-size: 14px;
              padding: 8px 16px;
              transition: background 0.3s;
          }

          .clear-btn:hover {
              background: rgba(255, 255, 255, 0.3);
          }

          .typing-cursor {
              display: inline-block;
              width: 2px;
              height: 20px;
              background: #667eea;
              animation: blink 1s infinite;
              margin-left: 2px;
          }

          @keyframes blink {
              0%, 50% { opacity: 1; }
              51%, 100% { opacity: 0; }
          }

          .thinking-info {
              display: flex;
              align-items: center;
              gap: 8px;
              color: #666;
              font-size: 14px;
              margin-bottom: 8px;
          }

          .thinking-timer {
              color: #667eea;
              font-weight: bold;
          }

          .streaming-message {
              min-height: 20px;
          }

          .message.assistant.streaming .message-content {
              border-color: #667eea;
              background: #f8f9ff;
          }
      </style>
  </head>
  <body>
      <div class="chat-container">
          <div class="chat-header">
              <div class="header-left">
                  <div class="header-title">ç”Ÿæ´»é—®é¢˜è§£å†³åŠ©æ‰‹</div>
                  <div class="header-user" id="userInfo">æ¬¢è¿ï¼Œç”¨æˆ·</div>
              </div>
              <div class="header-right">
                  <button class="upgrade-btn" onclick="goToUpgrade()">ğŸ’ å‡çº§è´¦æˆ·</button>
                  <button class="clear-btn" onclick="clearChat()">æ¸…é™¤å¯¹è¯</button>
                  <button class="header-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
              </div>
          </div>
          <div class="chat-messages" id="chatMessages">
              <div class="message assistant">
                  <div class="message-content">
                      ä½ å¥½ï¼æˆ‘æ˜¯ç”Ÿæ´»é—®é¢˜è§£å†³åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                  </div>
              </div>
          </div>
          <div class="chat-input">
              <textarea
                  class="input-field"
                  id="messageInput"
                  placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..."
                  rows="1"
                  onkeypress="handleKeyPress(event)"
                  oninput="autoResize(this)"
              ></textarea>
              <button class="send-button" id="sendButton" onclick="sendMessage()">
                  å‘é€
              </button>
          </div>
      </div>

      <script>
          let isLoading = false;
          let currentUser = null;
          let conversationHistory = [];
          let authToken = null;

          // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
          window.onload = function() {
              authToken = localStorage.getItem('token');
              const username = localStorage.getItem('username');

              if (!authToken || !username) {
                  window.location.href = 'login.html';
                  return;
              }

              // åˆå§‹æ˜¾ç¤ºç”¨æˆ·åï¼Œè¯¦ç»†çŠ¶æ€ç¨ååŠ è½½
              document.getElementById('userInfo').textContent = `æ¬¢è¿ï¼Œ${username}`;

              // éªŒè¯tokenå¹¶åŠ è½½èŠå¤©å†å²
              verifyTokenAndLoadHistory();
          };

          async function verifyTokenAndLoadHistory() {
              try {
                  const response = await fetch('/api/verify-token', {
                      headers: {
                          'Authorization': `Bearer ${authToken}`
                      }
                  });

                  if (response.ok) {
                      // Tokenæœ‰æ•ˆï¼ŒåŠ è½½èŠå¤©å†å²å’Œç”¨æˆ·çŠ¶æ€
                      await loadChatHistory();
                      await loadUserStatus();
                  } else {
                      // Tokenæ— æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                      localStorage.removeItem('token');
                      localStorage.removeItem('username');
                      window.location.href = 'login.html';
                  }
              } catch (error) {
                  console.error('Token verification failed:', error);
                  localStorage.removeItem('token');
                  localStorage.removeItem('username');
                  window.location.href = 'login.html';
              }
          }

          async function loadChatHistory() {
              try {
                  const response = await fetch('/api/chat-history', {
                      headers: {
                          'Authorization': `Bearer ${authToken}`
                      }
                  });

                  if (response.ok) {
                      const data = await response.json();
                      conversationHistory = data.history || [];

                      // é‡å»ºèŠå¤©ç•Œé¢
                      const chatMessages = document.getElementById('chatMessages');
                      chatMessages.innerHTML = `
                          <div class="message assistant">
                              <div class="message-content">
                                  ä½ å¥½ï¼æˆ‘æ˜¯ç”Ÿæ´»é—®é¢˜è§£å†³åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                              </div>
                          </div>
                      `;

                      conversationHistory.forEach(msg => {
                          addMessage(msg.role, msg.content);
                      });
                  }
              } catch (error) {
                  console.error('Error loading chat history:', error);
              }
          }

          async function saveChatHistory() {
              try {
                  await fetch('/api/chat-history', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${authToken}`
                      },
                      body: JSON.stringify({ history: conversationHistory })
                  });
              } catch (error) {
                  console.error('Error saving chat history:', error);
              }
          }

          async function loadUserStatus() {
              try {
                  const response = await fetch('/api/user-status', {
                      headers: {
                          'Authorization': `Bearer ${authToken}`
                      }
                  });

                  if (response.ok) {
                      const status = await response.json();
                      const username = localStorage.getItem('username');

                      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                      const planName = {
                          'free': 'å…è´¹ç‰ˆ',
                          'basic': 'åŸºç¡€ç‰ˆ',
                          'premium': 'é«˜çº§ç‰ˆ'
                      }[status.planType] || 'æœªçŸ¥å¥—é¤';

                      document.getElementById('userInfo').textContent =
                          `${username} | ${planName} | å‰©ä½™é—®é¢˜ï¼š${status.remainingQuestions}/${status.questionsLimit}`;

                      // å¦‚æœé—®é¢˜ç”¨å®Œäº†ï¼Œç¦ç”¨è¾“å…¥
                      if (status.remainingQuestions <= 0) {
                          const messageInput = document.getElementById('messageInput');
                          const sendButton = document.getElementById('sendButton');
                          messageInput.disabled = true;
                          messageInput.placeholder = 'é—®é¢˜æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·å‡çº§å¥—é¤ç»§ç»­ä½¿ç”¨';
                          sendButton.disabled = true;
                          sendButton.textContent = 'éœ€è¦å‡çº§';
                      }
                  }
              } catch (error) {
                  console.error('Error loading user status:', error);
              }
          }

          function handleKeyPress(event) {
              if (event.key === 'Enter' && !event.shiftKey) {
                  event.preventDefault();
                  sendMessage();
              }
          }

          function autoResize(textarea) {
              textarea.style.height = 'auto';
              textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
          }

          async function sendMessage() {
              const messageInput = document.getElementById('messageInput');
              const sendButton = document.getElementById('sendButton');
              const chatMessages = document.getElementById('chatMessages');

              const message = messageInput.value.trim();
              if (!message || isLoading) return;

              // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
              addMessage('user', message);
              conversationHistory.push({role: 'user', content: message});
              messageInput.value = '';
              messageInput.style.height = 'auto';

              // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
              isLoading = true;
              sendButton.disabled = true;
              sendButton.textContent = 'å‘é€ä¸­...';

              // ç«‹å³åˆ›å»ºAIæ¶ˆæ¯æ¡†
              const aiMessageDiv = document.createElement('div');
              aiMessageDiv.className = 'message assistant streaming';

              // åˆ›å»ºæ€è€ƒçŠ¶æ€æ˜¾ç¤º
              const thinkingDiv = document.createElement('div');
              thinkingDiv.className = 'thinking-info';
              thinkingDiv.innerHTML = `
                  <div class="typing-indicator">
                      <span></span>
                      <span></span>
                      <span></span>
                  </div>
                  <span>AIæ­£åœ¨æ€è€ƒ...</span>
                  <span class="thinking-timer">0s</span>
              `;

              // åˆ›å»ºæ¶ˆæ¯å†…å®¹åŒºåŸŸ
              const messageContent = document.createElement('div');
              messageContent.className = 'message-content streaming-message';
              messageContent.innerHTML = '<span class="typing-cursor"></span>';

              aiMessageDiv.appendChild(thinkingDiv);
              aiMessageDiv.appendChild(messageContent);
              chatMessages.appendChild(aiMessageDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;

              // å¼€å§‹è®¡æ—¶
              const startTime = Date.now();
              const timerInterval = setInterval(() => {
                  const elapsed = Math.floor((Date.now() - startTime) / 1000);
                  const timerElement = thinkingDiv.querySelector('.thinking-timer');
                  if (timerElement) {
                      timerElement.textContent = `${elapsed}s`;
                  }
              }, 1000);

              try {
                  // è°ƒç”¨åç«¯èŠå¤©æ¥å£
                  const response = await fetch('/api/chat', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${authToken}`
                      },
                      body: JSON.stringify({
                          message: message
                      })
                  });

                  if (!response.ok) {
                      const errorData = await response.json();
                      if (response.status === 403 && errorData.needUpgrade) {
                          // é—®é¢˜æ¬¡æ•°ç”¨å®Œï¼Œéœ€è¦å‡çº§
                          clearInterval(timerInterval);
                          thinkingDiv.remove();
                          messageContent.innerHTML = `
                              <div style="text-align: center; padding: 20px;">
                                  <p style="color: #e74c3c; font-weight: bold; margin-bottom: 15px;">
                                      ${errorData.message}
                                  </p>
                                  <p style="color: #666; margin-bottom: 15px;">
                                      å½“å‰å¥—é¤ï¼š${errorData.currentPlan === 'free' ? 'å…è´¹ç‰ˆ' : errorData.currentPlan === 'basic' ? 'åŸºç¡€ç‰ˆ' : 'é«˜çº§ç‰ˆ'}<br>
                                      å·²ä½¿ç”¨ï¼š${errorData.questionsUsed}/${errorData.questionsLimit} ä¸ªé—®é¢˜
                                  </p>
                                  <button onclick="goToUpgrade()" style="
                                      background: linear-gradient(45deg, #ffd700, #ffed4e);
                                      border: none;
                                      border-radius: 15px;
                                      color: #333;
                                      cursor: pointer;
                                      font-size: 14px;
                                      font-weight: bold;
                                      padding: 10px 20px;
                                      transition: all 0.3s;
                                  ">
                                      ğŸ’ ç«‹å³å‡çº§
                                  </button>
                              </div>
                          `;
                          aiMessageDiv.classList.remove('streaming');

                          // ç¦ç”¨è¾“å…¥
                          const messageInput = document.getElementById('messageInput');
                          const sendButton = document.getElementById('sendButton');
                          messageInput.disabled = true;
                          messageInput.placeholder = 'é—®é¢˜æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·å‡çº§å¥—é¤ç»§ç»­ä½¿ç”¨';
                          sendButton.disabled = true;
                          sendButton.textContent = 'éœ€è¦å‡çº§';

                          return;
                      }
                      throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                  }

                  const data = await response.json();
                  const aiMessage = data.reply;

                  // æ¸…é™¤è®¡æ—¶å™¨å’Œæ€è€ƒçŠ¶æ€
                  clearInterval(timerInterval);
                  thinkingDiv.remove();

                  // ç§»é™¤æ‰“å­—å…‰æ ‡ï¼Œå‡†å¤‡æ˜¾ç¤ºå†…å®¹
                  messageContent.innerHTML = '';

                  // é€å­—æ˜¾ç¤ºæ•ˆæœ
                  await typeText(messageContent, aiMessage);
                  chatMessages.scrollTop = chatMessages.scrollHeight;

                  // å®Œæˆè¾“å‡º
                  aiMessageDiv.classList.remove('streaming');
                  conversationHistory.push({role: 'assistant', content: aiMessage});

                  // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
                  await loadUserStatus();

              } catch (error) {
                  console.error('Error:', error);

                  // æ¸…é™¤è®¡æ—¶å™¨
                  clearInterval(timerInterval);

                  // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                  thinkingDiv.remove();
                  messageContent.innerHTML = 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚';
                  aiMessageDiv.classList.remove('streaming');
              } finally {
                  isLoading = false;
                  if (!sendButton.disabled) {  // åªæœ‰åœ¨æ²¡æœ‰è¢«å…¶ä»–é€»è¾‘ç¦ç”¨çš„æƒ…å†µä¸‹æ‰é‡æ–°å¯ç”¨
                      sendButton.disabled = false;
                      sendButton.textContent = 'å‘é€';
                  }

                  // ä¿å­˜èŠå¤©å†å²
                  await saveChatHistory();
              }
          }

          // æ‰“å­—æ•ˆæœå‡½æ•°
          async function typeText(element, text) {
              for (let i = 0; i < text.length; i++) {
                  element.textContent += text[i];
                  // è°ƒæ•´æ‰“å­—é€Ÿåº¦ï¼Œè®©ä½“éªŒæ›´æµç•…
                  await new Promise(resolve => setTimeout(resolve, 30));
              }
          }

          function addMessage(role, content) {
              const chatMessages = document.getElementById('chatMessages');
              const messageDiv = document.createElement('div');
              messageDiv.className = `message ${role}`;

              const messageContent = document.createElement('div');
              messageContent.className = 'message-content';
              messageContent.textContent = content;

              messageDiv.appendChild(messageContent);
              chatMessages.appendChild(messageDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
          }

          async function clearChat() {
              const chatMessages = document.getElementById('chatMessages');
              chatMessages.innerHTML = `
                  <div class="message assistant">
                      <div class="message-content">
                          ä½ å¥½ï¼æˆ‘æ˜¯ç”Ÿæ´»é—®é¢˜è§£å†³åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
                      </div>
                  </div>
              `;
              conversationHistory = [];
              await saveChatHistory();
          }

          function logout() {
              localStorage.removeItem('token');
              localStorage.removeItem('username');
              window.location.href = 'login.html';
          }

          function goToUpgrade() {
              window.location.href = 'upgrade.html';
          }
      </script>
  </body>
  </html>
